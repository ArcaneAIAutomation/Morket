name: Deploy

on:
  push:
    branches: [develop, main]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
        with:
          fetch-depth: 0

      - name: Set image tag
        id: meta
        run: echo "tag=${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: Secret scanning with gitleaks
        run: |
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz | tar xz
          chmod +x gitleaks
          ./gitleaks detect --source . --verbose --exit-code 1

      - name: Verify no secrets in Docker build context
        run: |
          echo "Checking for .env files in build context..."
          if find . -name '.env' -o -name '.env.*' -o -name '.env.local' -o -name '.env.production' | grep -v node_modules | grep -v .git | grep -q .; then
            echo "ERROR: .env files found in Docker build context:"
            find . -name '.env' -o -name '.env.*' -o -name '.env.local' -o -name '.env.production' | grep -v node_modules | grep -v .git
            exit 1
          fi
          echo "Checking for common secret patterns in tracked files..."
          if git ls-files | xargs grep -l -E '(AKIA[0-9A-Z]{16}|-----BEGIN (RSA |EC |DSA )?PRIVATE KEY-----|sk_live_[a-zA-Z0-9]{24,}|ghp_[a-zA-Z0-9]{36}|xox[bpoas]-[a-zA-Z0-9-]+)' 2>/dev/null; then
            echo "ERROR: Potential secrets/API keys detected in tracked files"
            exit 1
          fi
          echo "No secrets detected in Docker build context"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a0945b076 # v2

      - name: Build and push backend
        uses: docker/build-push-action@4a13e500e55cf31b7a5d59a38ab2040ab0f42f56 # v5
        with:
          context: .
          file: docker/backend.Dockerfile
          push: true
          tags: |
            ${{ steps.ecr.outputs.registry }}/morket-backend:${{ steps.meta.outputs.tag }}
            ${{ steps.ecr.outputs.registry }}/morket-backend:latest

      - name: Build and push scraper
        uses: docker/build-push-action@4a13e500e55cf31b7a5d59a38ab2040ab0f42f56 # v5
        with:
          context: .
          file: docker/scraper.Dockerfile
          push: true
          tags: |
            ${{ steps.ecr.outputs.registry }}/morket-scraper:${{ steps.meta.outputs.tag }}
            ${{ steps.ecr.outputs.registry }}/morket-scraper:latest

      - name: Build and push frontend
        uses: docker/build-push-action@4a13e500e55cf31b7a5d59a38ab2040ab0f42f56 # v5
        with:
          context: .
          file: docker/frontend.Dockerfile
          push: true
          tags: |
            ${{ steps.ecr.outputs.registry }}/morket-frontend:${{ steps.meta.outputs.tag }}
            ${{ steps.ecr.outputs.registry }}/morket-frontend:latest

  deploy-staging:
    needs: build-and-push
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a0945b076 # v2

      - name: Run database migrations
        run: |
          aws ecs run-task \
            --cluster morket-staging \
            --task-definition morket-staging-backend \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=${{ secrets.PRIVATE_SUBNET_IDS }},securityGroups=[${{ secrets.ECS_SECURITY_GROUP_ID }}],assignPublicIp=DISABLED}" \
            --overrides '{"containerOverrides":[{"name":"backend","command":["node","dist/migrations/runner.js"]}]}' \
            --query 'tasks[0].taskArn' \
            --output text | xargs -I {} aws ecs wait tasks-stopped --cluster morket-staging --tasks {}

      - name: Update backend service
        run: |
          aws ecs update-service \
            --cluster morket-staging \
            --service morket-staging-backend \
            --force-new-deployment \
            --query 'service.serviceName'
          aws ecs wait services-stable \
            --cluster morket-staging \
            --services morket-staging-backend

      - name: Update scraper service
        run: |
          aws ecs update-service \
            --cluster morket-staging \
            --service morket-staging-scraper \
            --force-new-deployment \
            --query 'service.serviceName'
          aws ecs wait services-stable \
            --cluster morket-staging \
            --services morket-staging-scraper

      - name: Update temporal worker service
        run: |
          aws ecs update-service \
            --cluster morket-staging \
            --service morket-staging-temporal-worker \
            --force-new-deployment \
            --query 'service.serviceName'

      - name: Deploy frontend to S3
        run: |
          CONTAINER_ID=$(docker create ${{ steps.ecr.outputs.registry }}/morket-frontend:${{ needs.build-and-push.outputs.image_tag }})
          docker cp $CONTAINER_ID:/usr/share/nginx/html ./frontend-dist
          docker rm $CONTAINER_ID
          aws s3 sync ./frontend-dist s3://morket-staging-frontend-assets --delete
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

  deploy-production:
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a0945b076 # v2

      - name: Run database migrations
        run: |
          TASK_ARN=$(aws ecs run-task \
            --cluster morket-production \
            --task-definition morket-production-backend \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=${{ secrets.PRIVATE_SUBNET_IDS }},securityGroups=[${{ secrets.ECS_SECURITY_GROUP_ID }}],assignPublicIp=DISABLED}" \
            --overrides '{"containerOverrides":[{"name":"backend","command":["node","dist/migrations/runner.js"]}]}' \
            --query 'tasks[0].taskArn' \
            --output text)
          aws ecs wait tasks-stopped --cluster morket-production --tasks $TASK_ARN
          EXIT_CODE=$(aws ecs describe-tasks --cluster morket-production --tasks $TASK_ARN --query 'tasks[0].containers[0].exitCode' --output text)
          if [ "$EXIT_CODE" != "0" ]; then
            echo "Migration failed with exit code $EXIT_CODE"
            exit 1
          fi

      - name: Update backend service
        run: |
          aws ecs update-service \
            --cluster morket-production \
            --service morket-production-backend \
            --force-new-deployment
          aws ecs wait services-stable \
            --cluster morket-production \
            --services morket-production-backend

      - name: Update scraper service
        run: |
          aws ecs update-service \
            --cluster morket-production \
            --service morket-production-scraper \
            --force-new-deployment
          aws ecs wait services-stable \
            --cluster morket-production \
            --services morket-production-scraper

      - name: Update temporal worker service
        run: |
          aws ecs update-service \
            --cluster morket-production \
            --service morket-production-temporal-worker \
            --force-new-deployment

      - name: Deploy frontend to S3
        run: |
          CONTAINER_ID=$(docker create ${{ steps.ecr.outputs.registry }}/morket-frontend:${{ needs.build-and-push.outputs.image_tag }})
          docker cp $CONTAINER_ID:/usr/share/nginx/html ./frontend-dist
          docker rm $CONTAINER_ID
          aws s3 sync ./frontend-dist s3://morket-production-frontend-assets --delete
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"
